/*! jodo-widget 2016-12-23 */
var Table={config:{dom:"",id:"",ajaxType:"",url:"",pageSize:"",cookieKey:"",reqCookie:"",otherReqData:"",reqData:{}},init:function(){console.log("table init");var a=this,b=Object.create(HTMLElement.prototype);b.createdCallback=function(){a.config.dom=this,a.config.id=this.getAttribute("data-id"),a.config.ajaxType=this.getAttribute("data-ajaxType"),a.config.url=this.getAttribute("data-url"),a.config.pageSize=this.getAttribute("data-pageSize"),a.config.cookieKey=this.getAttribute("data-cookie"),a.config.reqCookie=this.getAttribute("data-reqCookie"),a.config.otherReqData=this.getAttribute("data-otherReqData"),a.requestData()},b.attachedCallback=function(){},document.registerElement("tag-table",{prototype:b})},requestData:function(){var a=this;this.config.reqData=window.PubFunc.getCookie(this.config.reqCookie),this.config.reqData.pageSize=this.config.pageSize,this.config.reqData.currentPage=1;var b=JSON.parse(this.config.otherReqData);for(var c in b)this.config.reqData[c]=b[c];return!this.config.reqData.hasOwnProperty("undefined")&&(a._renderData(this,{id:a.config.id}),void $.ajax({type:a.config.ajaxType,url:a.config.url,data:JSON.stringify(a.config.reqData),dataType:"json",contentType:"application/json",success:function(b){console.log("%csuccess","background: green; color: white;"),setTimeout(function(){a._renderData(a.config.dom,{id:a.config.id,ajaxType:a.config.ajaxType,pageSize:a.config.pageSize,cookieKey:a.config.cookieKey,data:b.data})},100)},error:function(){console.log("%cerror","background: red; color: white;")}}))},_renderData:function(a,b){var c=this,d="",e='<div class="btn-toolbar"><div class="btn-group pull-right focus-btn-group"><button class="btn btn-success">导出Excel</button><button class="btn btn-success showAllColumns">显示所有列</button></div></div>';if(b.data instanceof Object&&b.data.sort.length>0){var f=b.data.head;console.log(f);for(var g=0;g<f.length;g++)d+="<th>"+f[g]+'<span class="hideColumn" title="隐藏" data-column='+g+">×</span></th>";a.innerHTML='<div class="m_dataTable">'+e+'<table id="'+b.id+'" class="display dt-bootstrap" cellspacing="0" width="100%"><thead><tr>'+d+"</tr></thead><tbody></tbody></table></div>",$("#"+b.id).tablesorter().bind("sortEnd",function(a){var c=b.cookieKey,d=a.target.config.sortList,e="orderColumn="+d[0][0]+"&orderDir="+d[0][1];window.PubFunc.setCookie(c,e,7),console.log(a.target.config.sortList)});for(var h=[],i=b.data.sort,g=0;g<i.length;g++)h.push({data:i[g]});var j={sProcessing:"处理中...",sLengthMenu:"每页 _MENU_ 项",sZeroRecords:"没有匹配结果",sInfo:"当前显示第 _START_ 至 _END_ 项，共 _TOTAL_ 项",sInfoEmpty:"当前显示第 0 至 0 项，共 0 项",sInfoFiltered:"(由 _MAX_ 项结果过滤)",sInfoPostFix:"",sSearch:"搜索:",sUrl:"",sEmptyTable:"表中数据为空",sLoadingRecords:"载入中...",sInfoThousands:",",oPaginate:{sFirst:"首页",sPrevious:"上一页",sNext:"下一页",sLast:"末页",sJump:"跳转"},oAria:{sSortAscending:": 以升序排列此列",sSortDescending:": 以降序排列此列"}},k=$("#"+b.id).DataTable({pageLength:b.data.page.pageSize+1,lengthChange:!1,searching:!1,language:j,ordering:!1,processing:!0,serverSide:!0,ajax:function(d,e,f){var g=c.config.reqData;g.currentPage=d.start/d.length+1,$.ajax({type:b.ajaxType,url:a.getAttribute("data-url"),cache:!1,data:JSON.stringify(g),dataType:"json",contentType:"application/json",success:function(a){var c={};c.draw=d.draw,c.recordsTotal=a.data.page.recordCount,c.recordsFiltered=a.data.page.recordCount;var f=a.data.page.resList;f.push(a.data.total),c.data=f,e(c),$("#"+b.id).trigger("update"),setTimeout(function(){var a=[[1,1]],c=window.PubFunc.getCookie(b.cookieKey);c.hasOwnProperty("undefined")||(a=[[parseInt(c.orderColumn[0]),parseInt(c.orderDir[0])]]),$("#"+b.id).trigger("sorton",[a])},1)}})},columns:h});$(".hideColumn").bind("click",function(a){a.stopPropagation(),k.column($(this).attr("data-column")).visible(!1)}),$(".showAllColumns").bind("click",function(){k.columns().visible(!0)})}else a.innerHTML='<div class="m_dataTable"><div class="w_tableEmptyLoading">表格加载中，请稍后...</div></div>'}};Table.init();